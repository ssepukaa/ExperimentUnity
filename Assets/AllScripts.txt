// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Boot\BootCore.cs
using UnityEngine;

namespace Assets.Game.Scripts.Boot
{
    public class BootCore : MonoBehaviour
    {
        public static BootCore Instance;

        private void Awake()
        {
            if (Instance == null)
            {
                Instance = this;
                DontDestroyOnLoad(gameObject);
            }
            else
            {
                Destroy(gameObject);
            }
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Data\GameConfig.cs
using System;
using System.Collections.Generic;
using UnityEngine;

namespace Assets.Game.Scripts.Data {
    [Serializable]
    public enum MicrobeType {
        Chloroplast,
        Amoeba,
        GreenEuglena,
        Infusoria,
        Chloromonad,
        Chlorella,
        Bacteria,
    }

    [Serializable]
    public class GameConfig {
        // Prefab References
        [SerializeField] public  const string PlayerPrefab = "Assets/Game/Prefabs/Units/PlayerPrefab.prefab";
        [SerializeField] public const string MicrobePrefab = "Assets/Game/Prefabs/Units/MicrobePrefab.prefab";
        // [SerializeField] public const string AnotherMicrobePrefab = "Assets/Game/Prefabs/Units/AnotherMicrobePrefab.prefab";
        // [SerializeField] public const string СhloroplastPrefab = "Assets/Game/Prefabs/Units/СhloroplastPrefab.prefab";

        [SerializeField] public readonly List<UnitConfig> Units = new List<UnitConfig> {
            new UnitConfig()
            {
                // Пустой элемент 1
                TypeName = MicrobeType.Amoeba,
                PrefabName = PlayerPrefab,

            },
            new UnitConfig()
            {
                // Пустой элемент 2
                TypeName = MicrobeType.Chloroplast,
                PrefabName = MicrobePrefab,

            },

        };

        [SerializeField] public readonly List<LevelConfig> Levels = new List<LevelConfig>{
            new LevelConfig
            {
                worldSize = new Vector3(20f,20f,0),
                minMicrobeCount = 3,
                maxMicrobeCount = 6
            },

        };

        // Animation References
        public readonly Dictionary<MicrobeType, Dictionary<string, string>> AnimationReferences =
            new Dictionary<MicrobeType, Dictionary<string, string>>
            {
                {
                    MicrobeType.Amoeba, new Dictionary<string, string>
                    {
                        { "Idle", "Assets/Game/Animations/amoeba_idle.anim" },
                        { "Move", "Assets/Game/Animations/amoeba_move.anim" },
                        { "Attack", "Assets/Game/Animations/amoeba_attack.anim" }
                    }
                },
                {
                    MicrobeType.Chloroplast, new Dictionary<string, string>
                    {
                        { "Idle", "Assets/Game/Animations/amoeba_idle.anim" },
                        { "Move", "Assets/Game/Animations/amoeba_move.anim" },
                        { "Attack", "Assets/Game/Animations/amoeba_attack.anim" }
                    }
                }
            };

       

    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Data\LevelConfig.cs
using UnityEngine;

namespace Assets.Game.Scripts.Data
{
    [System.Serializable]
    public class LevelConfig {
        public Vector3 worldSize;
        public int minMicrobeCount;
        public int maxMicrobeCount;
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Data\UnitConfig.cs
namespace Assets.Game.Scripts.Data
{
    [System.Serializable]
    public class UnitConfig {
        public MicrobeType TypeName;
        public string PrefabName;
        //public Dictionary<string, string> Animations;
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Editor\ScriptsCollector.cs
using UnityEngine;
using System.IO;
using UnityEditor;

public class ScriptsCollector : MonoBehaviour {
    [MenuItem("Tools/Collect All Scripts")]
    static void CollectAllScripts() {
        string assetsPath = Application.dataPath; // Получаем путь к папке Assets
        string[] scriptFiles = Directory.GetFiles(assetsPath, "*.cs", SearchOption.AllDirectories); // Ищем все файлы .cs в папке Assets и подпапках
        string outputFile = Path.Combine(assetsPath, "AllScripts.txt"); // Файл для сохранения объединённого скрипта

        using (StreamWriter writer = new StreamWriter(outputFile, false)) // Создаём поток для записи в файл
        {
            foreach (string scriptFile in scriptFiles) {
                string contents = File.ReadAllText(scriptFile); // Читаем содержимое файла
                writer.WriteLine("// File: " + scriptFile); // Добавляем комментарий с именем файла
                writer.WriteLine(contents); // Записываем содержимое файла
                writer.WriteLine("\n\n"); // Добавляем разделители между файлами
            }
        }

        Debug.Log("All scripts have been collected to " + outputFile); // Выводим сообщение об успешной операции
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameController.cs
using System.Collections.Generic;
using Assets.Game.Scripts.Bases.BaseControllers;
using Assets.Game.Scripts.Bases.BaseModels;
using Assets.Game.Scripts.Data;
using Assets.Game.Scripts.GameC.GameServices;
using Assets.Game.Scripts.GameC.GameStates;
using UnityEngine;

namespace Assets.Game.Scripts.GameC {

    public class GameController : MonoBehaviour, IGameController {
        public static GameController Instance;
        public string Id => "Game";

        public GameModel Model => _model;
        public GameView View => _view;

        [SerializeReference] private List<BaseModel> _models;
        [SerializeReference] private List<BaseGameService> _services;


        [SerializeField] private GameConfig _gameConfig;

        private BaseGameState _currentGameState;
        private BaseGameState _previousGameState;
        private GameModel _model = new GameModel();
        private GameView _view;
        private List<BaseGameState> _states = new List<BaseGameState>();
        private RandomService _randomService;
        private SaveLoadService _saveLoadService;
        private ControllerFactoryService _controllerService;
        private LevelGenerationService _levelGenerateService;
        private AnimationPoolService _animationSevrvice;

        public RandomService RandomService => GetService<RandomService>();

        public GameConfig Config => _gameConfig;

        private void Awake() {
            if (Instance == null) {
                Instance = this;
                DontDestroyOnLoad(gameObject);
            } else {
                Destroy(gameObject);
            }

            _gameConfig = new GameConfig();
        }

        private void Start() {
            _view = GetComponent<GameView>();
            InitializeGameServices();
            InitializeGameStates();
            Invoke("LoadingGame", 1f);

        }

        private void LoadingGame() {
            ChangeGameState<LoadingGameState>();
        }

        private void InitializeGameServices() {

            _services = new List<BaseGameService>();
            _services.Add(_randomService = new RandomService());
            _services.Add(_saveLoadService = new SaveLoadService());
            _services.Add(_controllerService = new ControllerFactoryService(this));
            _services.Add(_levelGenerateService = new LevelGenerationService(this, Config, 10f)); // Передаем конфигурацию и сервис случайных чисел
            _services.Add(_animationSevrvice = new AnimationPoolService());
        }
        private void InitializeGameStates() {
            _states.Add(new LoadingGameState(this));
            _states.Add(new GameplayGameState(this));
            _states.Add(new PausedGameState(this));
        }

        private void Update() {
            _currentGameState?.Execute();
            RunControllers();
        }

        private void RunControllers() {
            var controllerFactory = GetService<ControllerFactoryService>();
            var updatableControllers = controllerFactory.GetUpdatableControllers();
            int count = updatableControllers.Count;
            for (int i = 0; i < count; i++) {
                updatableControllers[i].Run();
            }
        }

        private void FixedUpdate() {
            FixedRunControllers();
        }

        private void FixedRunControllers() {
            var controllerFactory = GetService<ControllerFactoryService>();
            var fixedUpdatableControllers = controllerFactory.GetFixedUpdatableControllers();
            int count = fixedUpdatableControllers.Count;
            for (int i = 0; i < count; i++) {
                fixedUpdatableControllers[i].RunFixed();
            }
        }

        private void LateUpdate() {
            LateRunControllers();
        }

        private void LateRunControllers() {
            var controllerFactory = GetService<ControllerFactoryService>();
            var lateUpdatableControllers = controllerFactory.GetLateUpdatableControllers();
            int count = lateUpdatableControllers.Count;
            for (int i = 0; i < count; i++) {
                lateUpdatableControllers[i].RunLate();
            }
        }

        public void ChangeGameState<T>() where T : BaseGameState {
            var stateType = typeof(T);
            var newState = _states.Find(state => state.GetType() == stateType);
            if (newState != null) {
                if (_currentGameState != null && _currentGameState.Equals(newState)) {
                    Debug.Log($"This state {newState.ToString()} is already turned on!");
                    return;
                }

                _currentGameState?.Exit();
                _previousGameState = _currentGameState;
                _currentGameState = newState;
                _currentGameState.Enter();
            } else {
                Debug.LogError($"State {stateType} is not initialized.");
            }
        }

        public void CreateNewListControllers(List<BaseModel> models) {
            _models = models;
            var controllerFactory = GetService<ControllerFactoryService>();
            controllerFactory.CreateNewListControllers(models);
        }
        // Новый метод для создания контроллеров на основании конфига

        public void AddController(BaseController controller) {
            var controllerFactory = GetService<ControllerFactoryService>();
            controllerFactory.AddController(controller);
            var view = (controller as BaseController)?.View;

        }

        public void RemoveController(BaseController controller) {
            var controllerFactory = GetService<ControllerFactoryService>();
            controllerFactory.RemoveController(controller);
            var view = (controller as BaseController)?.View;

        }
        public T GetService<T>() where T : BaseGameService {
            return (T)_services.Find(service => service is T);
        }

        public void Save() {
            GetService<SaveLoadService>().Save(GetService<ControllerFactoryService>().Controllers);
        }

        public AnimationPoolService GetAnimationService() {
            return GetService<AnimationPoolService>();
        }
        public UnitConfig GetUnitConfig(MicrobeType typeName) {
            return _gameConfig.Units.Find(unit => unit.TypeName == typeName);
        }
    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameModel.cs
using Assets.Game.Scripts.Bases.BaseModels;

namespace Assets.Game.Scripts.GameC
{
    public class GameModel : BaseModel
    {
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameView.cs
using Assets.Game.Scripts.Bases.BaseViews;

namespace Assets.Game.Scripts.GameC
{
    public class GameView: BaseView
    {
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\IGameController.cs
using Assets.Game.Scripts.GameC.GameServices;

namespace Assets.Game.Scripts.GameC
{
    public interface IGameController
    {
        RandomService RandomService { get; }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\MicrobeC\MicrobeController.cs
using Assets.Game.Scripts.Bases.BaseControllers;
using Assets.Game.Scripts.Bases.Interfaces;
using UnityEngine;

namespace Assets.Game.Scripts.MicrobeC {
    [System.Serializable]
    public class MicrobeController : BaseController,IUpdatable {
        [SerializeField] protected MicrobeModel _model;

        public MicrobeController(MicrobeModel model) : base(model) {
            _model = model;
        }

        public override void Run() {
            // Логика обновления игрока
        }
    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\MicrobeC\MicrobeModel.cs
using Assets.Game.Scripts.Bases.BaseModels;
using Assets.Game.Scripts.Data;
using Newtonsoft.Json;
using UnityEngine;

namespace Assets.Game.Scripts.MicrobeC {
    [JsonObject(MemberSerialization.OptIn)]
    [System.Serializable]
    public class MicrobeModel : BaseModel {
        public MicrobeModel() {
            Speed = 3;
            Type = MicrobeType.Chloroplast;
        }
        [JsonProperty("health")]
        [SerializeField] private float health;
        [JsonProperty("speed")]
        [SerializeField] private float speed;

        public float Health {
            get => health;
            set => health = value;
        }
        public float Speed {
            get => speed;
            set => speed = value;
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\MicrobeC\MicrobeView.cs

using Assets.Game.Scripts.Bases.BaseViews;

namespace Assets.Game.Scripts.MicrobeC {
    public class MicrobeView: BaseView  {

    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\PlayerC\PlayerController.cs
using System.Collections;
using Assets.Game.Scripts.Bases.BaseControllers;
using Assets.Game.Scripts.Bases.Interfaces;
using Assets.Game.Scripts.Data;
using Assets.Game.Scripts.GameC;
using Assets.Game.Scripts.Services.InputServices;
using Assets.Game.Scripts.Services.MovementServices;
using UnityEngine;

namespace Assets.Game.Scripts.PlayerC {
    [System.Serializable]
    public class PlayerController : BaseController, IUpdatable {
        [SerializeField] protected PlayerModel _model;
        private IInputService _inputService;
        private MovementService _movementService;

        public PlayerController(PlayerModel model) : base(model) {
            _model = model;
        }

        protected override void InitServices() {
            base.InitServices();
            _inputService = Application.isMobilePlatform ? new MobileInputService() : new DesktopInputService();
            var animationService = GameController.Instance.GetService<AnimationPoolService>();

            // Получаем словарь с анимациями для данного типа микроба
            var animationAddresses = GameController.Instance.Config.AnimationReferences[_model.Type];

            // Передаем словарь в AnimationPoolService для инициализации
            animationService.Initialize(animationAddresses);

            // Передаем AnimationPoolService в MovementService
            _movementService = new MovementService(_view.transform, _model, _view.GetComponent<Animator>(), animationService);
            _isInitComplete = true;
        }

        public override void Run() {
            base.Run();
            if (_inputService.IsInputActive()) {
                Vector3 inputPosition = _inputService.GetInputPosition();
                inputPosition.z = 0; // Установка Z-координаты в 0 для 2D
                _movementService.SetTarget(inputPosition);
            }

            _movementService.UpdateState();

            // Пример атаки (замените условие на вашу логику)
            if (Input.GetKeyDown(KeyCode.Space)) {
                if (_movementService.TryPlayAttackAnimation()) {
                    _view.StartCoroutine(StopAttackAfterDelay(1.0f)); // Замените 1.0f на длительность анимации атаки
                }
            }
        }

        private IEnumerator StopAttackAfterDelay(float delay) {
            yield return new WaitForSeconds(delay);
            _movementService.StopAttackAnimation();
        }
    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\PlayerC\PlayerModel.cs
using Assets.Game.Scripts.Bases.BaseModels;
using Assets.Game.Scripts.Bases.Interfaces;
using Assets.Game.Scripts.Data;
using Newtonsoft.Json;
using UnityEngine;

namespace Assets.Game.Scripts.PlayerC {
    [JsonObject(MemberSerialization.OptIn)]
    [System.Serializable]
    public class PlayerModel : BaseModel, IMovable {
        public PlayerModel() {
            Speed = 5f;
            Type = MicrobeType.Amoeba;
        }

        [JsonProperty("health")]
        [SerializeField] private float health = 100f;
        [JsonProperty("speed")]
        [SerializeField] private float speed;

        public float Health {
            get => health;
            set => health = value;
        }

        public float Speed {
            get => speed;
            set => speed = value;
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\PlayerC\PlayerView.cs
using Assets.Game.Scripts.Bases.BaseViews;

namespace Assets.Game.Scripts.PlayerC {
    public class PlayerView: BaseView {
    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Tests\TestAnimation.cs
using UnityEngine;

public class TestAnimation : MonoBehaviour {
    public Animator animator;

    void Start() {
        animator = GetComponent<Animator>();
    }

    void Update() {
        if (Input.GetKeyDown(KeyCode.Alpha1)) {
            animator.Play("amoeba_idle");
        }
        if (Input.GetKeyDown(KeyCode.Alpha2)) {
            animator.Play("amoeba_move");
        }
        if (Input.GetKeyDown(KeyCode.Alpha3)) {
            animator.Play("amoeba_attack");
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Bases\BaseControllers\BaseController.cs
using Assets.Game.Scripts.Bases.BaseModels;
using Assets.Game.Scripts.Bases.BaseViews;
using Assets.Game.Scripts.GameC;
using Assets.Game.Scripts.GameC.GameServices;
using UnityEngine;

namespace Assets.Game.Scripts.Bases.BaseControllers {
    [System.Serializable]
    public abstract class BaseController {
        protected BaseModel _model;
        //protected BaseModel _baseModel;
        [SerializeField] protected BaseView _view;

        [SerializeField] public string Id => _model.Id;
        public BaseModel Model => _model;
        public BaseView View => _view;
        protected bool _isInitComplete;

        protected BaseController(BaseModel model) {
            _model = model;

        }

        public void SetView(BaseView view) {
            _view = view;
           if (view != null) {
                view.Initialize(_model);
                GetComponentsOnView();
                _view.Model = Model;
                GameController.Instance.GetService<ControllerFactoryService>().AddView(_view);
            }


        }

        protected virtual void GetComponentsOnView() {
            InitServices();
        }
        protected virtual void InitServices() {
        }

        public virtual void Run() {
            if (!_isInitComplete) return;
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Bases\BaseModels\BaseModel.cs
using Assets.Game.Scripts.Data;
using Newtonsoft.Json;
using UnityEngine;

namespace Assets.Game.Scripts.Bases.BaseModels {
    [JsonObject(MemberSerialization.OptIn)]
    [System.Serializable]
    public abstract class BaseModel {
        [JsonProperty("id")]
        [SerializeField] private string id;

        [JsonProperty("type")]
        [SerializeField] private MicrobeType type;

        [JsonProperty("position")]
        [SerializeField] private Vector3 position;

        [JsonProperty("rotation")]
        [SerializeField] private Quaternion rotation;

        [JsonProperty("scale")]
        [SerializeField] private Vector3 scale;

       

        public string Id {
            get => id;
            set => id = value;
        } 
        public MicrobeType Type {
            get => type;
            set => type = value;
        }

        public Vector3 Position {
            get => position;
            set => position = value;
        }

        public Quaternion Rotation {
            get => rotation;
            set => rotation = value;
        }

        public Vector3 Scale {
            get => scale;
            set => scale = value;
        }

    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Bases\BaseModels\IMovable.cs
namespace Assets.Game.Scripts.Bases.Interfaces {
    public interface IMovable {
        float Speed { get; }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Bases\BaseViews\BaseView.cs
using Assets.Game.Scripts.Bases.BaseModels;
using UnityEngine;

namespace Assets.Game.Scripts.Bases.BaseViews {
    [System.Serializable]
    public abstract class BaseView : MonoBehaviour {
        [SerializeField] public string _id;
        //[SerializeField] private BaseModel _model;
        [SerializeReference] public BaseModel _model;

        public string Id {
            get => _id;
            set => _id = value;
        }

        public BaseModel Model
        {
            get => _model;
            set => _model = value;
        }

        public virtual void Initialize(BaseModel model) {
            Id = model.Id;
            transform.position = model.Position;
            transform.rotation = model.Rotation;
            transform.localScale = model.Scale;
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Bases\Interfaces\IFixedUpdatable.cs
namespace Assets.Game.Scripts.Bases.Interfaces
{
    public interface IFixedUpdatable
    {
        void RunFixed();
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Bases\Interfaces\ILateUpdatable.cs
namespace Assets.Game.Scripts.Bases.Interfaces
{
    public interface ILateUpdatable
    {
        void RunLate();
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Bases\Interfaces\IUpdatable.cs
namespace Assets.Game.Scripts.Bases.Interfaces
{
    public interface IUpdatable
    {
        void Run();
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameServices\AnimationPoolService.cs
using System.Collections.Generic;
using Assets.Game.Scripts.GameC.GameServices;
using UnityEngine;
using UnityEngine.AddressableAssets;
using UnityEngine.ResourceManagement.AsyncOperations;

public class AnimationPoolService : BaseGameService {
    private readonly Dictionary<string, AnimationClip> _animationClips = new Dictionary<string, AnimationClip>();
    private AnimatorOverrideController _animatorOverrideController;

    public void Initialize(Dictionary<string, string> animationAddresses) {
        foreach (var animation in animationAddresses) {
            LoadAnimationClip(animation.Key, animation.Value);
        }
    }

    private void LoadAnimationClip(string key, string address) {
        if (!_animationClips.ContainsKey(key)) {
            Addressables.LoadAssetAsync<AnimationClip>(address).Completed += handle => {
                if (handle.Status == AsyncOperationStatus.Succeeded) {
                    _animationClips[key] = handle.Result;
                    Debug.Log($"Loaded animation clip for key: {key} from address: {address}");
                } else {
                    Debug.LogWarning($"Failed to load animation clip for key: {key} from address: {address}");
                }
            };
        }
    }

    public AnimationClip GetAnimationClip(string key) {
        _animationClips.TryGetValue(key, out var clip);
        return clip;
    }

    public void InitializeAnimator(Animator animator) {
        _animatorOverrideController = new AnimatorOverrideController(animator.runtimeAnimatorController);
        animator.runtimeAnimatorController = _animatorOverrideController;
    }

    public void SetAnimation(Animator animator, string animationName, AnimationClip clip) {
        if (_animatorOverrideController != null) {
            _animatorOverrideController[animationName] = clip;
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameServices\BaseGameService.cs
namespace Assets.Game.Scripts.GameC.GameServices
{
    [System.Serializable]
    public abstract class BaseGameService
    {
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameServices\ControllerFactoryService.cs
using System;
using System.Collections.Generic;
using Assets.Game.Scripts.Bases.BaseControllers;
using Assets.Game.Scripts.Bases.BaseModels;
using Assets.Game.Scripts.Bases.BaseViews;
using Assets.Game.Scripts.Bases.Interfaces;
using Assets.Game.Scripts.MicrobeC;
using Assets.Game.Scripts.PlayerC;
using UnityEngine;
using UnityEngine.AddressableAssets;

namespace Assets.Game.Scripts.GameC.GameServices {
    [Serializable]
    public class ControllerFactoryService : BaseGameService {
        private GameController _game;
        [SerializeReference] private List<BaseController> _controllers;
        [SerializeReference] private List<BaseView> _views; // Добавление списка View
        [SerializeReference] private List<IUpdatable> _updatableControllers;
        [SerializeReference] private List<IFixedUpdatable> _fixedUpdatableControllers;
        [SerializeReference] private List<ILateUpdatable> _lateUpdatableControllers;

        private Transform _parentTransform;
        public List<BaseController> Controllers => _controllers;
        public ControllerFactoryService(GameController game) {
            _game = game;
            _controllers = new List<BaseController>();
            _views = new List<BaseView>();
            _updatableControllers = new List<IUpdatable>();
            _fixedUpdatableControllers = new List<IFixedUpdatable>();
            _lateUpdatableControllers = new List<ILateUpdatable>();


        }



        public void CreateNewListControllers(List<BaseModel> models) {
            // Создаем родительский объект в точке (0, 0, 0) и задаем ему имя
            GameObject parentGameObject = new GameObject("SpawnedObjects");
            parentGameObject.transform.position = Vector3.zero;
            _parentTransform = parentGameObject.transform;

            Controllers.Clear();
            _views.Clear();
            _updatableControllers.Clear();
            _fixedUpdatableControllers.Clear();
            _lateUpdatableControllers.Clear();

            foreach (var model in models) {
                AddController(CreateController(model));
            }
        }

        public void AddController(BaseController controller) {
            Controllers.Add(controller);
            if (controller is IUpdatable updatableController) {
                _updatableControllers.Add(updatableController);
            }
            if (controller is IFixedUpdatable fixedUpdatableController) {
                _fixedUpdatableControllers.Add(fixedUpdatableController);
            }
            if (controller is ILateUpdatable lateUpdatableController) {
                _lateUpdatableControllers.Add(lateUpdatableController);
            }


        }

        public void RemoveController(BaseController controller) {
            Controllers.Remove(controller);
            if (controller is IUpdatable updatableController) {
                _updatableControllers.Remove(updatableController);
            }
            if (controller is IFixedUpdatable fixedUpdatableController) {
                _fixedUpdatableControllers.Remove(fixedUpdatableController);
            }
            if (controller is ILateUpdatable lateUpdatableController) {
                _lateUpdatableControllers.Remove(lateUpdatableController);
            }

            // Удаление View
            RemoveView(controller.View);
        }

        public List<IUpdatable> GetUpdatableControllers() {
            return _updatableControllers;
        }

        public List<IFixedUpdatable> GetFixedUpdatableControllers() {
            return _fixedUpdatableControllers;
        }

        public List<ILateUpdatable> GetLateUpdatableControllers() {
            return _lateUpdatableControllers;
        }

        public BaseController CreateController(BaseModel model) {
            Debug.Log($"_game.GetUnitConfig(model.Type) =={_game.GetUnitConfig(model.Type)}");
            var prefab = Addressables.LoadAssetAsync<GameObject>(_game.GetUnitConfig(model.Type).PrefabName).WaitForCompletion();
            if (prefab == null) {
                throw new ArgumentException("Prefab not found: " + model.Type);
            }
            var gameObject = UnityEngine.Object.Instantiate(prefab, _parentTransform);
            var view = gameObject.GetComponent<BaseView>();
            if (model is PlayerModel playerModel) {
                var controller = new PlayerController(playerModel);
                controller.SetView(view);
                return controller;
            }
            if (model is MicrobeModel microbeModel) {
                var controller = new MicrobeController(microbeModel);
                controller.SetView(view);
                return controller;
            }
            // // Добавление View
            // AddView(view);
            throw new ArgumentException("Unknown model type");
        }

        public void AddView(BaseView gameObject) {
            var view = gameObject.GetComponent<BaseView>();
            if (view != null) {
                _views.Add(view);
            }
        }

        private void RemoveView(BaseView gameObject) {
            var view = gameObject.GetComponent<BaseView>();
            if (view != null) {
                _views.Remove(view);
            }
        }

    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameServices\LevelGenerationService.cs
using System.Collections.Generic;
using Assets.Game.Scripts.Bases.BaseModels;
using Assets.Game.Scripts.Data;
using Assets.Game.Scripts.MicrobeC;
using Assets.Game.Scripts.PlayerC;
using UnityEngine;

namespace Assets.Game.Scripts.GameC.GameServices {
    public class LevelGenerationService : BaseGameService {
        private GameConfig _gameConfig;
        private IGameController _gameController;
        private float _minDistanceBetweenMicrobes;

        public LevelGenerationService(IGameController gameController,GameConfig gameConfig, float minDistanceBetweenMicrobes)
        {
            _gameController = gameController;
            _gameConfig = gameConfig;
            _minDistanceBetweenMicrobes = minDistanceBetweenMicrobes;
        }

        public List<BaseModel> GenerateInitialModels() {
            var models = new List<BaseModel>();

            // Генерация игрока
            var playerModel = new PlayerModel {
                Id = System.Guid.NewGuid().ToString(),
                Position = new Vector3(0, 0, 0), // Задайте начальную позицию игрока
                Rotation = Quaternion.identity,
                Scale = Vector3.one,
                Health = 100, // Начальное значение здоровья игрока
                Speed = 5f
            };
            models.Add(playerModel);

            // Генерация микробов
            var levelConfig = _gameConfig.Levels[0]; // Пример использования первого уровня из конфигурации
            int microbeCount = _gameController.RandomService.RandomRange(levelConfig.minMicrobeCount, levelConfig.maxMicrobeCount);

            for (int i = 0; i < microbeCount; i++) {
                Vector3 position;
                bool positionIsValid;

                do {
                    position = _gameController.RandomService.RandomPosition(levelConfig.worldSize);
                    positionIsValid = true;

                    foreach (var model in models) {
                        if (Vector3.Distance(position, model.Position) < _minDistanceBetweenMicrobes) {
                            positionIsValid = false;
                            break;
                        }
                    }
                } while (!positionIsValid);

                var microbeModel = new MicrobeModel {
                    Id = System.Guid.NewGuid().ToString(),
                    Position = position,
                    Rotation = Quaternion.identity,
                    Scale = Vector3.one,
                    Health = 50 // Начальное значение здоровья микроба
                };
                models.Add(microbeModel);
            }

            return models;
        }
    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameServices\RandomService.cs
using UnityEngine;

namespace Assets.Game.Scripts.GameC.GameServices {
    public class RandomService : BaseGameService {
        private System.Random _random = new System.Random();

        public int RandomRange(int min, int max) {
            return _random.Next(min, max);
        }

        public Vector3 RandomPosition(Vector3 worldSize) {
            float x = (float)_random.NextDouble() * worldSize.x - worldSize.x / 2;
            float y = (float)_random.NextDouble() * worldSize.y - worldSize.y / 2;
            float z = (float)_random.NextDouble() * worldSize.z - worldSize.z / 2;
            return new Vector3(x, y, z);
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameServices\SaveLoadService.cs
using System.Collections.Generic;
using System.IO;
using Assets.Game.Scripts.Bases.BaseControllers;
using Assets.Game.Scripts.Bases.BaseModels;
using Newtonsoft.Json;
using UnityEngine;

namespace Assets.Game.Scripts.GameC.GameServices {
    public class SaveLoadService : BaseGameService {
        private readonly string saveFilePath;

        public SaveLoadService() {
            saveFilePath = Path.Combine(Application.persistentDataPath, "saveData.json");
        }

        public void Save(List<BaseController> controllers) {
            List<BaseModel> models = new List<BaseModel>();
            foreach (var controller in controllers) {
                models.Add(controller.Model);
            }

            JsonSerializerSettings settings = new JsonSerializerSettings {
                Formatting = Formatting.Indented,
                TypeNameHandling = TypeNameHandling.Auto,
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                Converters = new List<JsonConverter> {
                    new Vector3Converter(),
                    new QuaternionConverter()
                }
            };

            string jsonData = JsonConvert.SerializeObject(models, settings);
            File.WriteAllText(saveFilePath, jsonData);
        }

        public List<BaseModel> Load() {
            if (!File.Exists(saveFilePath)) {
                return null;
            }

            string jsonData = File.ReadAllText(saveFilePath);
            JsonSerializerSettings settings = new JsonSerializerSettings {
                TypeNameHandling = TypeNameHandling.Auto,
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                Converters = new List<JsonConverter> {
                    new Vector3Converter(),
                    new QuaternionConverter()
                }
            };

            return JsonConvert.DeserializeObject<List<BaseModel>>(jsonData, settings);
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameServices\Vector3Converter.cs
using Newtonsoft.Json.Linq;
using Newtonsoft.Json;
using System;
using UnityEngine;

namespace Assets.Game.Scripts.GameC.GameServices {
    public class Vector3Converter : JsonConverter {

        public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer) {
            Vector3 vector = (Vector3)value;
            JObject jo = new JObject
            {
                { "x", vector.x },
                { "y", vector.y },
                { "z", vector.z }
            };
            jo.WriteTo(writer);
        }

        public override object ReadJson(JsonReader reader, Type objectType, object existingValue,
            JsonSerializer serializer) {
            JObject jo = JObject.Load(reader);
            float x = (float)jo["x"];
            float y = (float)jo["y"];
            float z = (float)jo["z"];
            return new Vector3(x, y, z);
        }

        public override bool CanConvert(Type objectType) {
            return objectType == typeof(Vector3);
        }
    }

    public class QuaternionConverter : JsonConverter {
        public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer) {
            Quaternion quaternion = (Quaternion)value;
            JObject jo = new JObject
            {
                { "x", quaternion.x },
                { "y", quaternion.y },
                { "z", quaternion.z },
                { "w", quaternion.w }
            };
            jo.WriteTo(writer);
        }

        public override object ReadJson(JsonReader reader, Type objectType, object existingValue,
            JsonSerializer serializer) {
            JObject jo = JObject.Load(reader);
            float x = (float)jo["x"];
            float y = (float)jo["y"];
            float z = (float)jo["z"];
            float w = (float)jo["w"];
            return new Quaternion(x, y, z, w);
        }

        public override bool CanConvert(Type objectType) {
            return objectType == typeof(Quaternion);
        }
    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameStates\BaseGameState.cs
using Assets.Game.Scripts.Bases.Interfaces;
using UnityEngine;

namespace Assets.Game.Scripts.GameC.GameStates
{
    public abstract class BaseGameState
    {
        public GameController GameController;

        public BaseGameState(GameController gameController)
        {
            GameController = gameController;
        }

        public virtual void Enter()
        {
            Debug.Log($"Enter {GetType().Name}");
        }

        public virtual void Exit()
        {
            Debug.Log($"Exit {GetType().Name}");
        }

        public virtual void Execute()
        {
            // Debug.Log($"Execute {GetType().Name}");
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameStates\GameplayGameState.cs
namespace Assets.Game.Scripts.GameC.GameStates
{
    public class GameplayGameState : BaseGameState
    {
        public GameplayGameState(GameController gameController) : base(gameController)
        {
        }

        public override void Enter()
        {
            base.Enter();
            // ������ ��� ������ ����
        }

        public override void Execute()
        {
            base.Execute();
            // ������ ��� ���������� �������� �����
        }

        public override void Exit()
        {
            base.Exit();
            // ������ ��� ������ �� ��������� ����
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameStates\LoadingGameState.cs
using Assets.Game.Scripts.GameC.GameServices;

namespace Assets.Game.Scripts.GameC.GameStates {
    public class LoadingGameState : BaseGameState {
        private GameController _game;

        public LoadingGameState(GameController game) : base(game) {
            _game = game;
        }

        public override void Enter() {
            base.Enter();
            LoadOrGenerateModels();
        }

        private void LoadOrGenerateModels() {
            var saveLoadService = _game.GetService<SaveLoadService>();
            var models = saveLoadService.Load();

            if (models == null || models.Count == 0) {
                var levelGenerationService = _game.GetService<LevelGenerationService>();
                models = levelGenerationService.GenerateInitialModels();
            }

            _game.CreateNewListControllers(models);
            _game.ChangeGameState<GameplayGameState>();
            _game.Save();
        }

        public override void Execute() {
            base.Execute();
        }

        public override void Exit() {
            base.Exit();
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameStates\MenuGameState.cs
using UnityEngine;

namespace Assets.Game.Scripts.GameC.GameStates
{
    public class MenuGameState: BaseGameState {
        public override void Enter()
        {
            Debug.Log("Enter MenuGameState");
        }

        public override void Exit()
        {
            Debug.Log("Exit MenuGameState");
        }

        public override void Execute()
        {
            Debug.Log("Execute MenuGameState");
        }

        public MenuGameState(GameController gameController) : base(gameController)
        {
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameStates\NewGameState.cs
using Assets.Game.Scripts.Bases.Interfaces;
using UnityEngine;

namespace Assets.Game.Scripts.GameC.GameStates
{
    public class NewGameState : BaseGameState
    {
        public override void Enter()
        {
            Debug.Log("Enter NewGameState");
        }

        public override void Exit()
        {
            Debug.Log("Exit NewGameState");
        }

        public override void Execute()
        {
            Debug.Log("Execute NewGameState");
        }

        public NewGameState(GameController gameController) : base(gameController)
        {
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\GameC\GameStates\PausedGameState.cs
using UnityEngine;

namespace Assets.Game.Scripts.GameC.GameStates
{
    public class PausedGameState : BaseGameState
    {
        public PausedGameState(GameController gameController) : base(gameController)
        {
        }

        public override void Enter()
        {
            base.Enter();

            Time.timeScale = 0;
        }

        public override void Execute()
        {
            base.Execute();
        }

        public override void Exit()
        {
            base.Exit();

            Time.timeScale = 1;
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Services\InputServices\DesktopInputService.cs
using UnityEngine;

namespace Assets.Game.Scripts.Services.InputServices
{
    public class DesktopInputService : IInputService
    {
        public Vector3 GetInputPosition()
        {
            return Camera.main.ScreenToWorldPoint(Input.mousePosition);
        }

        public bool IsInputActive()
        {
            return Input.GetMouseButtonDown(0);
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Services\InputServices\IInputService.cs
using UnityEngine;

namespace Assets.Game.Scripts.Services.InputServices {
    public interface IInputService {
        Vector3 GetInputPosition();
        bool IsInputActive();
    }
}




// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Services\InputServices\MobileInputService.cs
using UnityEngine;

namespace Assets.Game.Scripts.Services.InputServices
{
    public class MobileInputService : IInputService {
        public Vector3 GetInputPosition() {
            if (Input.touchCount > 0) {
                return Camera.main.ScreenToWorldPoint(Input.GetTouch(0).position);
            }

            return Vector3.zero;
        }

        public bool IsInputActive()
        {
            return Input.touchCount > 0;
        }
    }
}



// File: C:/Unity/Projects2/Experiment/ExperimentUnity/Assets\Game\Scripts\Services\MovementServices\MovementService.cs
using System.Collections.Generic;
using UnityEngine;
using Assets.Game.Scripts.Bases.Interfaces;

namespace Assets.Game.Scripts.Services.MovementServices {
    public class MovementService {
        private Transform _transform;
        private Animator _animator;
        private AnimationPoolService _animationService;
        private Vector3? _targetPosition;
        private bool _isAttacking;
        private bool _isMoving;
        private readonly IMovable _movable;
        private Dictionary<string, AnimationClip> _animations;
        private int _currentAnimationHash;

        public MovementService(Transform transform, IMovable movable, Animator animator, AnimationPoolService animationService) {
            _transform = transform;
            _movable = movable;
            _animator = animator;
            _animationService = animationService;
            _animations = new Dictionary<string, AnimationClip>();
            LoadAnimations();
            _animationService.InitializeAnimator(_animator);
        }

        private void LoadAnimations() {
            _animations["Idle"] = _animationService.GetAnimationClip("Idle");
            _animations["Move"] = _animationService.GetAnimationClip("Move");
            _animations["Attack"] = _animationService.GetAnimationClip("Attack");
        }

        public void SetTarget(Vector3 targetPosition) {
            _targetPosition = targetPosition;
            if (!_isMoving && !_isAttacking) {
                PlayMoveAnimation();
                _isMoving = true;
            }
            Debug.Log("Target set to: " + targetPosition);
        }

        public void UpdateState() {
            if (_targetPosition.HasValue) {
                Vector3 direction = (_targetPosition.Value - _transform.position).normalized;
                if (Vector3.Distance(_transform.position, _targetPosition.Value) > 0.1f) {
                    _transform.position = Vector3.MoveTowards(_transform.position, _targetPosition.Value, _movable.Speed * Time.deltaTime);
                    RotateTowards(direction);
                    if (!_isAttacking && !_animator.GetCurrentAnimatorStateInfo(0).IsName("amoeba_attack")) {
                        PlayMoveAnimation();
                    }
                } else {
                    _targetPosition = null;
                    if (!_isAttacking) {
                        PlayIdleAnimation();
                        _isMoving = false;
                    }
                    Debug.Log("Reached target, switching to idle animation.");
                }
            } else if (!_isAttacking) {
                PlayIdleAnimation();
            }
        }

        private void PlayMoveAnimation() {
            PlayAnimation(_animations["Move"]);
        }

        private void RotateTowards(Vector3 direction) {
            if (direction != Vector3.zero) {
                Quaternion targetRotation = Quaternion.LookRotation(Vector3.forward, direction);
                _transform.rotation = Quaternion.Slerp(_transform.rotation, targetRotation, _movable.Speed * Time.deltaTime);
            }
        }

        public void PlayIdleAnimation() {
            PlayAnimation(_animations["Idle"]);
            _isMoving = false;
        }

        public bool TryPlayAttackAnimation() {
            if (!_isAttacking) {
                _isAttacking = true;
                BlendAnimation(_animations["Attack"], 0.5f); // Время смешивания 0.5 секунд
                return true;
            }
            return false;
        }

        private void PlayAnimation(AnimationClip clip) {
            if (clip == null) return;
            int animationHash = Animator.StringToHash(clip.name);
            if (_currentAnimationHash != animationHash) {
                _animator.Play(animationHash);
                _currentAnimationHash = animationHash;
                Debug.Log($"Playing animation: {clip.name}");
            }
        }

        private void BlendAnimation(AnimationClip clip, float blendDuration) {
            if (clip == null) return;
            int animationHash = Animator.StringToHash(clip.name);
            if (_currentAnimationHash != animationHash) {
                _animator.CrossFadeInFixedTime(animationHash, blendDuration);
                _currentAnimationHash = animationHash;
                Debug.Log($"Blending to animation: {clip.name}");
            }
        }

        public void StopAttackAnimation() {
            _isAttacking = false;
            if (_targetPosition.HasValue) {
                PlayMoveAnimation();
                _isMoving = true;
            } else {
                PlayIdleAnimation();
            }
        }
    }
}




